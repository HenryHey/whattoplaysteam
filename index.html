<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">

<head>
  <title>What to play on Steam?</title>
  <link href="./favicon.ico" rel="icon" type="image/x-icon" />

  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name=viewport content="width=device-width, initial-scale=1">
  <meta name="description" content="Do you have too many Steam games? Need help clearing the backlog? Come and get some recommendations">

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-126352481-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-126352481-1');
  </script>

  <link rel="stylesheet" href="./style.css">
  <link rel="stylesheet" href="./tinyslide.css">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tiny-slider/2.8.5/tiny-slider.css">
  <!--[if (lt IE 9)]><script src="https://cdnjs.cloudflare.com/ajax/libs/tiny-slider/2.8.5/min/tiny-slider.helper.ie8.js"></script><![endif]-->


</head>

<body>
  <div class="container">
    <div class="header">
      <!-- <h1>what to play on  <img src="https://steamstore-a.akamaihd.net/public/shared/images/header/globalheader_logo.png?t=962016"/></h1> -->
      <h1>what to play on  <img alt="Steam logo" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALAAAAAsCAYAAADFEzJmAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NzRCNDQ4RDY3NDU5MTFFNkFCRTlCMUI1NThBRjIwNTQiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NzRCNDQ4RDc3NDU5MTFFNkFCRTlCMUI1NThBRjIwNTQiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo3NEI0NDhENDc0NTkxMUU2QUJFOUIxQjU1OEFGMjA1NCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo3NEI0NDhENTc0NTkxMUU2QUJFOUIxQjU1OEFGMjA1NCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pv38DckAAArOSURBVHja7J0LdBTV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"/></h1>
    </div>
    <div id="randomLoading">
      <h2 >loading random game</h2>
      <div class="lds-facebook"><div></div><div></div><div></div></div>
    </div>
    <div id="random" style="display: none">
      <div class="randomName">
        <h2 id="randomGameTitle"><a href="#" onclick="resetRandom()">get another</a> random game from <a href="#" onclick="changeLibrary()">all</a> library</h2>
        <h2><a id="randomGameName" target="_blank"></a></h2>
      </div>
      <div class="gallery">
        <div id="randomGameScreenshots" class="randomSlider"></div>
      </div>
      <h2>about the game</h2>
      <div id="randomGameDescription" class="description"></div>
    </div>

    <div id="curatedLoading">
      <h2 >random game</h2>
      <div class="lds-facebook"><div></div><div></div><div></div></div>
    </div>
    <div id="curatedContainer">
      <div id="curated" style="display: none">
        <div class="curatedName">
            <h2>curated game</h2>
            <h2><a id="curatedGameName" target="_blank"></a></h2>
          </div>
          <div class="gallery">
            <div id="curatedGameScreenshots" class="curatedSlider">
            </div>
          </div>
          <div id="curatedGameDescription" class="description"></div>
      </div>
      <div id="promoted" class="promoted">
        <h2>promoted game</h2>
        <p>Your game here! Contact me <a href="https://twitter.com/whatToPlaySteam">@whatToPlaySteam!</a></p>
      </div>
    </div>
    <div class="footer">Copyright 2018 Enric Masdeu</div>
  </div>

  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="./calls.js"></script>
  <script>
    var sliders = {};
    var library = "all";

    const customDescription = (description, elem="curated") => {
      document.getElementById(elem + "GameDescription").innerHTML = description;
    }

    const filterDescription = (description) => {
      let outDescription = description;
      outDescription = outDescription.replace(/<br><br>/gi,"<br/>");
      outDescription = outDescription.replace(/<br\/><br\/>/gi,"<br/>");
      outDescription = outDescription.replace(/<br>\n<br>/gi,"<br/>");
      outDescription = outDescription.replace(/<br\/><br\/>/gi,"<br/>");
      return outDescription;
    };

    const updateWeb = (response, elem = "random") => {
      document.getElementById(elem + "Loading").style.display = "none";    
      document.getElementById(elem).style.display = "block";    
      document.getElementById(elem + "GameName").innerText = response.name;
      const steamUrl = "https://store.steampowered.com/app/" + response.steam_appid;
      const gameLink = document.getElementById(elem + "GameName");
      gameLink.setAttribute("href", steamUrl)
      gameLink.setAttribute("target", "_blank")
      gameLink.setAttribute("rel", "noopener noreferrer");

      let description = "";
      if (response.about_the_game) {
        description = response.about_the_game;
      } else if (response.short_description) {
        description = response.short_description;
      }
      description = filterDescription(description);
      document.getElementById(elem + "GameDescription").innerHTML = description;

      const sliderElem = document.getElementById(elem + "GameScreenshots-ow");
      console.log('sliderElem :', sliderElem);
      if (sliderElem) {
        const parent = document.getElementById(elem + "GameScreenshots-ow").parentNode;
        sliderElem.remove()
        let screenShotsElem = document.createElement('div');
        screenShotsElem.setAttribute("id", elem + "GameScreenshots");
        screenShotsElem.setAttribute("class", elem + "Slider");
        parent.appendChild(screenShotsElem);
        console.log('parent :', parent);
      }
      
      response.screenshots.forEach(screenshot => {
        let divElem = document.createElement('div');
        let img = document.createElement("img");
        img.setAttribute("src", screenshot.path_thumbnail);
        img.setAttribute("alt", "Screenshot");
        divElem.appendChild(img);
        document.getElementById(elem + "GameScreenshots").appendChild(divElem);
      });

      sliders[elem] = tns({
        "container": "." + elem + "Slider",
        "autowidth": true,
        "items": 1,
        "slideBy": 1,
        "mouseDrag": true,
        "swipeAngle": false,
        "controlsText": ['◀', '▶'],
        "speed": 400,
        "navAsThumbnails":true,
        "autoHeight": true,
        "lazyload": true
      });
    }
    const changeLibrary = () => {
      if (library === "all") {
        library = "my";
      } else {
        library = "all";
      }

      document.getElementById("randomGameTitle").innerHTML =
      `<a href="#" onclick="resetRandom()">get another</a> random game from <a href="#" onclick="changeLibrary()">${library}</a> library`;
    }

    const getGames = (appIds, i=0) => {
      console.log('i :', i);
      if (i < appIds.length) {
        const appId = appIds[i];
        const gameUrl = `https://store.steampowered.com/api/appdetails?appids=${appId}`;
        console.log('gameUrl :', gameUrl);
        let response = {};
        axios.get(gameUrl)
        .then( data => {
          const response = data.data[appId];
          if (isValidGame(response, appId)) {
            gameFound = true;
            updateWeb(response.data, "random");
          } else {
            i++;
            getGames(appIds, i);
          }
        })
        .catch( err => console.log('err :', err));
      }
    };

    const getGame = (appId, description = "", elem="random") => {
      const gameUrl = `https://store.steampowered.com/api/appdetails?appids=${appId}`;
      let response = {};
      axios.get(gameUrl)
      .then( data => {
        const response = data.data[appId].data;
        if (response) {
          console.log(response);
          updateWeb(response, elem);
          if (description) {
            customDescription(description);
          }
        }
      })
      .catch( err => console.log('err :', err));
      
    };

    const resetRandom = () => {
      document.getElementById("randomLoading").style.display = "block";    
      document.getElementById("random").style.display = "none";

      if (library === "all") {
        loadRandomGame();  
      } else {
        loadRandomGame(steamId);
      }
      
    }

    const filterSteamId = (steamId) = () => {
      return steamId;
    };

    const loadRandomGame = (steamId = "") => {
      let url = "https://p92qekdxx9.execute-api.us-east-2.amazonaws.com/prod/getSteamGames";
      // let url = "http://127.0.0.1:3000/1/getSteamGames";

      if (steamId) {
        steamId = filterSteamId(steamId);
        url += "?steamId=" + steamId;
      }
      axios.get(url)
        .then( data => {
          try {
            const response = JSON.parse(data.data.body).data;
            console.log('response :', response);
            updateWeb(response, "random");
          } catch (e) {
            console.log('data :', data);
          }

          document.getElementById("randomLoading").style.display = "none";    
          document.getElementById("random").style.display = "block"; 
        })
        .catch( err => console.log('err :', err));
    };

    const loadCuratedGame = () => {
      document.getElementById("curatedLoading").style.display = "block";    
      document.getElementById("curated").style.display = "none"; 

      const description =  '<p>3D platformer, very similar to 3D Mario games</p>';
      //getGame("322190", description, "curated");

      const url = "./steamworldHeist.json";
      axios.get(url)
        .then( data => {
          const response = data.data["253230"].data;

          console.log('curated :', response);
          updateWeb(response, "curated");
          customDescription(description);
        })
        .catch( err => console.log('err :', err));
    };

    loadRandomGame();
    loadCuratedGame();

    //const url = "http://api.steampowered.com/IPlayerService/GetOwnedGames/v0001/?key=5E0F8A4820D63CB92B24DDF4546BFF60&steamid=76561197997143584&format=json";
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tiny-slider/2.8.5/min/tiny-slider.js"></script>

</body>

</html>